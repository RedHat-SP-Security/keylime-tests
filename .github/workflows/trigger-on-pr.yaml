name: Testing Farm

on:
  workflow_run:
    workflows: ["Register PR"]
    types: [completed]

jobs:
  get_data:
    outputs:
      pr_number: ${{ steps.recover.outputs.pr_number }}
      pr_url: ${{ steps.recover.outputs.pr_url}}
      repo: ${{ steps.recover.outputs.repo }}
      branch: ${{ steps.recover.outputs.branch }}
      head_sha: ${{ steps.recover.outputs.head_sha }}
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - run: sudo apt-get install jq
        shell: bash
      - name: 'Download artifact'
        uses: actions/github-script@v6
        with:
          script: |
            let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "pr_data"
            })[0];
            let download = await github.rest.actions.downloadArtifact({
               owner: context.repo.owner,
               repo: context.repo.repo,
               artifact_id: matchArtifact.id,
               archive_format: 'zip',
            });
            let fs = require('fs');
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/pr_data.zip`, Buffer.from(download.data));
      - name: 'Recover data'
        id: recover
        shell: bash
        run: |
          unzip pr_data.zip
          echo "pr_number=$(jq -r .pr_number pr_data.json)" >> $GITHUB_OUTPUT
          echo "pr_url=$(jq -r .pr_url pr_data.json)" >> $GITHUB_OUTPUT
          echo "repo=$(jq -r .repo pr_data.json)" >> $GITHUB_OUTPUT
          echo "branch=$(jq -r .branch pr_data.json)" >> $GITHUB_OUTPUT
          echo "head_sha=$(jq -r .head_sha pr_data.json)" >> $GITHUB_OUTPUT
  pr_test:
    needs: get_data
    name: PR specific test
    uses: ./.github/workflows/pr-test.yaml
    with:
      distro: "fedora-37"
      compose: "Fedora-37"
      arch: "x86_64"
      plan: ${{ needs.get_data.outputs.pr_number }}
      pr_number: ${{ needs.get_data.outputs.pr_number }}
      pr_url: ${{ needs.get_data.outputs.pr_url }}
      repo: ${{ needs.get_data.outputs.repo }}
      branch: ${{ needs.get_data.outputs.branch }}
      head_sha: ${{ needs.get_data.outputs.head_sha }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      testing_farm_token: ${{ secrets.TESTING_FARM_API_TOKEN }}
  tier:
    needs: [get_data, pr_test]
    name: Tier tests
    uses: ./.github/workflows/tiers.yaml
    with:
      tier: "tier2"
      pr_number: ${{ needs.get_data.outputs.pr_number }}
      pr_url: ${{ needs.get_data.outputs.pr_url }}
      repo: ${{ needs.get_data.outputs.repo }}
      branch: ${{ needs.get_data.outputs.branch }}
      head_sha: ${{ needs.get_data.outputs.head_sha }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      testing_farm_token: ${{ secrets.TESTING_FARM_API_TOKEN }}

